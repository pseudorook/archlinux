#! /bin/bash

dir="$(dirname "$0")"

zsh="${dir}/packages/zsh.list"
zshrc="${dir}/dotfiles/zshrc"
zshdir="${HOME}/.zsh"
function install_zsh {
  show_header "Installing zsh."
  check_installed $(cat ${zsh})
  check_fail
  show_success "zsh installed."

  show_info "Downloading zsh extras."
  mkdir -p ${zshdir}
  if ! [ -d ${zshdir}/zsh-history-substring-search ]; then
    git clone https://github.com/zsh-users/zsh-history-substring-search \
      ${zshdir}/zsh-history-substring-search
  fi
  if ! [ -d ${zshdir}/zsh-autosuggestions ]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions \
      ${zshdir}/zsh-autosuggestions
  fi
  if ! [ -d ${zshdir}/zsh-themes ]; then
    git clone https://github.com/pseudorook/zsh-themes \
      ${zshdir}/zsh-themes
  fi

  show_info "Copying zshrc."
  cp -f ${zshrc} ${HOME}/.zshrc

  if ! test $(getent passwd `whoami` | grep "zsh"); then
    show_info "Changing login shell to zsh. Provide your password."
    chsh -s /bin/zsh
  fi
}

hardened="${dir}/packages/hardened.list"
function install_linux_hardened {
  show_header "Installing linux-hardened kernel."
  check_installed $(cat ${hardened})
  check_fail
  show_success "Hardened kernel installed."
}

lts="${dir}/packages/lts.list"
function install_linux_lts {
  show_header "Installing linux-lts kernel."
  check_installed $(cat ${lts})
  check_fail
  show_success "LTS kernel installed."
}

zen="${dir}/packages/zen.list"
function install_linux_zen {
  show_header "Installing linux-zen kernel."
  check_installed $(cat ${zen})
  check_fail
  show_success "Zen kernel installed."
}

utils="${dir}/packages/utils.list"
function install_utils {
  show_header "Installing general utilities."
  check_installed $(cat ${utils})
  check_fail
  show_success "Utilities installed."
}

laptop="${dir}/packages/laptop.list"
function install_laptop {
  show_header "Installing laptop utilities."
  check_installed $(cat ${laptop})
  check_fail
  show_success "Laptop utilities installed."

  # Enable tlp on laptops.
  show_info "Enabling and starting tlp systemd units."
  sudo systemctl enable tlp.service
  sudo systemctl start tlp.service
  sudo systemctl enable tlp-sleep.service
  sudo systemctl start tlp-sleep.service
  show_success "tlp enabled."
}

function 01-misc {
  show_question "Misc: what do you want to install?"
  show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"

  options=("Back" "All" "Linux hardened kernel" "Linux LTS kernel" \
           "Linux zen kernel" "Linux utilities" "Laptop tools" "zsh")
  select option in "${options[@]}"; do
    case $option in
      "Back")
        break
        ;;
      "All")
        install_linux_hardened
        install_linux_lts
        install_linux_zen
        install_utils
        install_laptop
        install_zsh
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "Linux hardened kernel")
        install_linux_hardened
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "Linux LTS kernel")
        install_linux_lts
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "Linux zen kernel")
        install_linux_zen
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "Linux utilities")
        install_utils
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "Laptop tools")
        install_laptop
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      "zsh")
        install_zsh
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
      *)
        show_warning "Invalid option."
        show_info "Main\n ${endbranch} Misc (Hit ENTER to see options again.)"
        ;;
    esac
  done
}
